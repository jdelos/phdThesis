\chapter[Modeling of H-SCC]{Modeling of Hybrid Switched Capacitor Converters}

Switch capacitor converters are circuits composed by a large number of switches and capacitors, and require accurate models to properly design them. SCCs have the peculiarity to be lossy by nature due to the non adiabatic energy transfer between capacitors, phenomenon not present in the inductor based converters. Generally, modeling of SCCs focuses just on  the description of the loss mechanisms associated to conduction and capacitor charge transfer, neglecting other sources of loss such as driving and switching loss. These loss mechanisms are proportional to the output current, thus are normally modeled with resistor in the well known output impedance model.

This chapter presents a new methodology to model a SCC when any of the nodes in the converter are loaded. The proposed methodology also include the effects of PWM control, thus accurately predicting the equivalent internal impedance and the converter conversion ratio.

The chapter is divided in two sections, the first section is devoted to the study and model a SCC when loaded from a \emph{pwm}-node, reviewing and extending the charge flow analysis~\cite{95Makowski,Seeman:EECS-2009-78} to include two new aspects that arise with the proposed hybrid converter. First, any of the nodes of the converter are considered as possible outputs that can be loaded. Second, the analysis includes the effects of duty cycle (PWM) in any of the operation regimes of the converter, and this alters the conversion ratio and the internal equivalent impedance. The previous models are discussed, and the limiting are factors identifying. Subsequently the charge flow analysis is reformulated using a new approach based on current-loaded outputs that leads a better accuracy and covers the analysis of both SCC and H-SCC. The new model is compared to circuit simulations and experimental data.

The second section is devoted to the study of multiple loaded H-SCC. Based on the well-known output impedance model, a new circuit representation for converters with multiple current-loaded outputs is presented. The related characterization methodology is developed to determine the parameters of said new model based on the current-loaded analysis presented in the first section. The resulting model is validated against simulation and experimental data.


\section{Single Output Converters}
Switched Capacitor Converters has been always treated as a two-port converter with single input and a single output as shown in Fig.\ref{fig:two_port}. The input port is connected to a voltage source and the output port feeds the load. The SCC provides between input, $v_i$, and output, $v_o$, a voltage conversion, $m$,  that  steps up, steps down or/and inverts the polarity of the input voltage. Up to present all the circuit theory devoted SCCs is valid only for the two-port configuration, therefore this section is dedicated to revisit the classical concepts of single output SCC and to introduce new ones that enable to study the H-SCC.

\begin{figure}[!h]
\centering
\ctikzset { bipoles/length=1cm}
\begin{circuitikz}[american voltages,scale=0.65]
\draw
    (1,0) to[short,o-]
    (0,0) to[V = $V_{supply}$]
    (0,3) to[short,-o]
    (1,3) ;

\draw
    (2,3) --
    (2.5,3)

    (2,0) --
    (2.5,0)

    node[ocirc]  (IC)  at (2,0) {}
    node[ocirc]  (I) at (2,3) {}
    (I) to[open,v=$v_{i}$] (IC);


\draw [thick]
    (2.5,-0.5) --
    (2.5,3.5)  --
    (5.5,3.5)  --
    (5.5,-0.5) --
    (2.5,-0.5);

\draw (4,2)node[anchor=north]{$\frac{v_o}{v_{i}}=m$} ;
\draw
    (5.5,3) -- (6,3)
    (5.5,0) -- (6,0)
    node[ocirc]  (O)  at (6,3) {}
    node[ocirc]  (OC) at (6,0) {}
    (O) to[open,v^<=$v_{o}$] (OC);

\draw
    (7,0) to[short,o-]
    (8,0) to[ R= $Load$,mirror]
    (8,3) to[short,-o]
    (7,3) ;
\end{circuitikz}
\caption{General two port configuration of a Switched Capacitor Converter. }
\label{fig:two_port}
\end{figure}

\subsection{The Output Impedance Model}
\begin{SCfigure}%[!h]
\centering
\ctikzset { bipoles/length=1cm}
\begin{circuitikz}[american voltages, scale=0.65]
\draw
    (-0.5,0) to[V = $ m \cdot v_{src}  $]
    (-0.50,3) -- (0,3) to[R,l=$r_{scc}$,-o]  (3,3)
    (3.5,3) to[short,o-,i=$i_o$]
    (4.25,3)   to[R,l=$r_o$]
    (4.25,0) to[short,-o] (3.5,0)
    (3,0) to[short,o-] (-0.5,0)
    (0,3) to[open,v^=$v_{trg}$] (0,0)
    (3.5,3) to[open,v=$v_{out}$] (3.5,0);

\end{circuitikz}
\caption{Output impedance model of a switched capacitor converter.}
\label{fig:scc_model_oi}
\end{SCfigure}
The behavior of SSCs is modeled with the well-known output impedance model~\cite{2000Oota,2012Peter} that is composed of a controlled voltage source and equivalent resistance $r_{scc}$, as shown in Figure~\ref{fig:scc_model_oi}.The output voltage provided by the converter under no-load conditions is defined as \emph{target voltage} ($v_{trg}$). It is modeled with the controlled voltage source, being the value of voltage supply $v_{src}$ multiplied by the conversion ratio $m$, thus
\begin{equation}
v_{trg} =  m \cdot v_{src} .
\label{eq:vtrg}
\end{equation}

When loaded, the voltage droop across $r_{scc}$ accounts for the loss produced in the converter. In fact, the loss are proportional to the output current $i_o$, that is why they are represented with a resistor. Hence the output voltage of the converter can be obtained as
\begin{equation}
v_{out} =  m \cdot v_{src} - i_o \cdot r_{scc} .
\label{eq:vout_scc}
\end{equation}

Up to day, there are two different methodologies to infer the equivalent output resistance $r_{scc}$, plotted in~\ref{fig:plot_rscc}. On the one hand, S. Ben-Yaakov  ~\cite{2009Ben-Yaakov,2012Ben-Yaakov,2013Evzelman} has claimed a generalized methodology based on the analytical solution of each of the different R-C transient circuits of the converter, reducing all of them to a single transient solution. The methodology achieves a high accuracy, but yields to a set of none linear equations and high complexity for the analysis of advanced architectures.

On the other hand,  M. Makowski and D. Maksimovic~\cite{95Makowski} presented a methodology based on the analysis of the charge flow between capacitors in steady-state. The methodology is simple to apply and yields with a set of linear expressions, being them easy to operate for further analysis of the converters. Based on the charge flow analysis, M.Seeman~\cite{Seeman:EECS-2009-78} developed different metrics allowing to compare performances between capacitive and inductive converters.

Although both methodologies are valid in the modeling of SCCs, none of them has been used to model the effects of a loaded \emph{pwm}-node, which is fundamental to study the H-SCC.  Nevertheless the charge flow analysis has a more clean and simplified way of describing the loss mechanism, based on the hypothesis that a SCC in steady-state has to have null charge balance in all the capacitors. That is why this methodology has been chosen in to model the H-SCC, although few modeling hypothesis have been reviewed and modified according to the operation of the new \emph{hybrid} switched capacitor converter.

\sidecaptionvpos{figure}{!b}
\begin{SCfigure} %[!h]
\centering
\begin{tikzpicture}[scale=0.85]
    \begin{loglogaxis}[
        %width=12cm,
        %height=8cm,
        xlabel near ticks,
        ylabel near ticks,
        xlabel= {$f_{sw} ~~ [Hz] $},
        ylabel= {$ [\Omega] $} ,
        axis line style={->},
        axis y line*=left,
        axis x line*=bottom,
        xtick=\empty, ytick=\empty,
        %ytick = {0,.125,.25},
        %yticklabels={0,$v_{src}\frac{1}{3}$,$v_{src}\frac{2}{3}$,$v_{src}$},
        domain=3e4:5e6,
        samples=100,
        %xticklabels={0,$D \cdot T_{sw}$,$T_{sw}$ ,$2 T_{sw}$,$3 T_{sw} $},
        legend style={at={(0.75,0.75)}, anchor= north east},
        enlarge x limits={0.0},
        enlarge y limits={0.0}
        ]

  \newcommand\C{1e-6}
  \newcommand\Resr{1}
  \newcommand\Dx{0.5}
  \newcommand\Rfsl{4*\Resr}
  \newcommand\lbssl{1e5}
  \newcommand\lbfsl{1e6}

  \addplot [thick]   { 1/(2*x*\C)*((exp(\Dx/(\Resr*x*\C))+1)/(exp(\Dx/(\Resr*x*\C))-1) + (exp((1-\Dx)/(\Resr*x*\C))+1)/(exp((1-\Dx)/(\Resr*x*\C))-1))};
  %\addplot [thick,dashed,marker=square] { sqrt((1/(2*\C*x))^2 + \Rfsl^2) };
  \addplot [thick,dashed,domain=3e4:3.5e5] { (1/(\C*x) };
  \addplot [thick,dotted,domain=2.5e4:5e6] { \Rfsl+0*x };
\legend {$r_{scc}$,$r_{ssl}$,$r_{fsl}$};
\end{loglogaxis}

\node[anchor=north] at (6.25cm,1.35cm){$FSL$};
\node[anchor=north,rotate=-60] at (1.25cm,5cm){$SSL$};

\end{tikzpicture}
\caption{SCC Equivalent output resistance $r_{scc}$ as function of the frequency and the two asymptotic limits: \emph{Slow Switching Limit} (SSL) and \emph{Fast Switching Limit}(FSL). }
\label{fig:plot_rscc}
\end{SCfigure}

As aforementioned $r_{scc}$ accounts for the loss when the converter is loaded. All losses in the converter are, in fact, dissipated in the resistive elements of the converter: \emph{on}-resistance $r_{on}$ of the switches and equivalent series resistance $r_{esr}$ of the capacitors, thus all loesses represented by $r_{scc}$ are conduction losses. Nevertheless, the origin and magnitude of the losses depends on the operation region of the converter, which is function of the switching frequency as shown in the plot of Figure~\ref{fig:plot_rscc}.

There are two well-defined operation regimes of the converter: the \emph{Slow Switching Limit} (SSL) and the \emph{Fast Switching Limit} (FSL), and each of the regime defines an asymptotic limit of the $r_{scc}$ curve. In SSL, the converter operates at a switching frequency $f_{sw}$ much lower than the time constant $\tau$ of the converter, thereby allowing the full charge and discharge of the capacitors as shown in Figure~\ref{fig:ic_ssl}. As shown in Figure~\ref{fig:ic_fsl} currents have exponential-shape waveforms. The losses are then determined by the charge transfer between capacitors, but dissipated in the resistive paths of the converter mainly in switch $r_{on}$. Therefore reducing the switch resistance will not reduce the losses, instead will produce sharper discharge currents in the switches producing more EMI. In that region $r_{scc}$ losses are inversely proportional of product between the switching frequency and capacitances, limited by the SSL asymptote (see Figure~\ref{fig:plot_rscc}).

In FSL, the converter operates with a switching frequency $f_{sw}$ much higher than the time constant $\tau$ of the converter, limiting the charge and discharge transient times of the capacitors; as shown in Figure~\ref{fig:ic_fsl} currents have block-shape waveforms. In such conditions losses totally depend on the parasitic resistive elements ($r_{on}$, $r_{esr}$), therefore changes in the capacitances or frequency do not modify the produces losses. In that region $r_{scc}$ is constant and limited by the FSL asymptote (see Figure~\ref{fig:plot_rscc}).

\begin{figure}[!h]
\centering
\ctikzset { bipoles/length=1cm}
\begin{subfigure}[t]{.45\textwidth}
    %\centering
    \raggedright
    \begin{tikzpicture}
            \begin{axis}[
                width={\textwidth},
                height={6cm},
                axis lines=middle,
                xlabel near ticks,
                ylabel near ticks,
                xlabel= {$time $},
                ylabel= {capacitor current},
                every axis x label/.style={
                    at={(ticklabel* cs:1.05)},
                    anchor=west,
                },
                x axis line style={->},
                y axis  line style={<->},
                xtick=\empty, ytick=\empty,
                %ytick = {0,.125,.25},
                %yticklabels={0,$v_{src}\frac{1}{3}$,$v_{src}\frac{2}{3}$,$v_{src}$},
                domain=-0.25:2,
                samples=100,
                %xticklabels={0,$D \cdot T_{sw}$,$T_{sw}$ ,$2 T_{sw}$,$3 T_{sw} $},
                xmin=-0.1,xmax=2.2,
                ymin=-1,ymax=1.2,
                ]

          \newcommand\xtauA{1/(3*5)};
          \newcommand\ioA{1};
          \newcommand\xtauB{3/(5*5)};
          \newcommand\ioB{-0.75};

          \addplot [thick,]   coordinates { (0,0) (0.1,0) (0.1,\ioA)};
          \addplot [thick,domain=0.1:1]   { \ioA*(  exp(-(x-0.1)/(\xtauA))) };
          \addplot [thick,domain=1:2]   coordinates { (1,0) (1,\ioB)};
          \addplot [thick,domain=1:2]   { \ioB*(  exp(-(x-1)/(\xtauB))) };



        \end{axis}
    \end{tikzpicture}
    \caption{Slow Switching Limit}
    \label{fig:ic_ssl}
\end{subfigure}
\hfill
\begin{subfigure}[t]{.45\textwidth}
    %\centering
    \raggedright
    \begin{tikzpicture}
            \begin{axis}[
                width={\textwidth},
                height={6cm},
                axis lines=middle,
                xlabel near ticks,
                ylabel near ticks,
                xlabel= {$time $},
                ylabel= {capacitor current},
                every axis x label/.style={
                    at={(ticklabel* cs:1.05)},
                    anchor=west,
                },
                x axis line style={->},
                y axis  line style={<->},
                xtick=\empty, ytick=\empty,
                %ytick = {0,.125,.25},
                %yticklabels={0,$v_{src}\frac{1}{3}$,$v_{src}\frac{2}{3}$,$v_{src}$},
                domain=0:2.2,
                samples=100,
                %xticklabels={0,$D \cdot T_{sw}$,$T_{sw}$ ,$2 T_{sw}$,$3 T_{sw} $},
                xmin=-0.1,xmax=2.2,
                ymin=-1,ymax=1.2,
                ]

          \newcommand\xtauA{7)};
          \newcommand\ioA{0.65};
          \newcommand\xtauB{10};
          \newcommand\ioB{-0.35};

          \addplot [thick,]   coordinates { (0,0) (0.1,0) (0.1,\ioA)};
          \addplot [thick,domain=0.1:1]   { \ioA*(  exp(-(x-0.1)/(\xtauA))) };
          \addplot [thick,domain=1:2]   coordinates { (1, { \ioA*exp(-(1-0.1)/(\xtauA))} ) (1,\ioB)};
          \addplot [thick,domain=1:2]   { \ioB*(  exp(-(x-1)/(\xtauB))) };
          \addplot [thick]   coordinates { (2, {\ioB*exp(-(1)/(\xtauB))} ) (2,\ioA)};



        \end{axis}
    \end{tikzpicture}
    \caption{Fast Switching Limit}
    \label{fig:ic_fsl}
\end{subfigure}
\caption{Current waveforms though the capacitors in each of the two regimes of operation. }
\label{fig:capacitor_current}
\end{figure}


\subsection{Revising the charge flow analysis}

The charge flow analysis method is based on charge conservation in the capacitors during a switching period when the converter is in steady state~\cite{95Makowski}. Based on the charge flow of the capacitors, the converter is studied in two well-defined operating regimes: the Slow Switching Limit (SSL) and the Fast Switching Limit (FSL). In SSL, losses are then dominated by the charge transfer between capacitors, therefore only the charge transfer loss mechanisms are studied.  In FSL, losses depend on the conduction through the parasitic resistive elements, therefore only the conduction losses are studied. This division in the study of the converter reduces the complexity of the problem, and enables a simplified but accurate analysis.

The charge flow analysis uses the flowing charges in the different elements of the converter instead of the currents. Furthermore, the charges are grouped in different charge flow vectors, each vector is normalized with respect to the total charge flow of an output of the converter.


\subsection{Load Model: Voltage Sink versus Current Sink}

In order to model a SCC, the original charge flow method~\cite{95Makowski} makes three main assumptions:
\begin{enumerate}
  \item The load is modeled as an ideal voltage source since it is normally connected to the \emph{dc}-output in parallel with a large capacitor, as shown in Figure~\ref{fig:vsink_load}. Such assumption, eliminates the capacitor connected in parallel with the load, neglecting the effects of the output capacitor to the equivalent resistance of the model.

  \item The model only considers the \emph{dc}-output as the single load point of the converter, imposing a unique output to the converter.

  \item The phase time ratio is not included in the computation of the capacitor charge flow. Consequently, the modulation of the switching period is assumed to have no influence on the amount of charge flowing in the capacitors.
\end{enumerate}

\begin{figure}[!h]
    \centering
    \ctikzset { bipoles/length=1cm}
    \begin{subfigure}[t]{.4\textwidth}
        \centering
        \begin{circuitikz}[american voltages,scale=0.65]
        \draw
                %Draw Switches
                (1,0)  to[V=$v_{src}$]
                (1,8)  --
                (5,8)   to[switch=$s_1$]
                (5,6)   to[switch=$s_2$]
                (5,4)   to[switch=$s_3$]
                (5,2)   to[switch=$s_4$]
                (5,0)  --
                (1,0)


        %Draw Capacitors
                (5,2) --
                (3,2) to[pC,l_=$c_{1}$]
                (3,6)--
                (5,6)

                (5,0) --
                (7,0) to[V,l_=$v_{out}$]
                (7,4)--
                (5,4);
        \end{circuitikz}
        \caption {Load modeled as a voltage sink.}
        \label{fig:vsink_load}
    \end{subfigure}
    \hfill
    \begin{subfigure}[t]{.4\textwidth}
        \centering
        \begin{circuitikz}[american,scale=0.65]
        \draw
                %Draw Switches
                (1,0)  to[V=$v_{src}$]
                (1,8)  --
                (5,8)   to[switch=$s_1$]
                (5,6)   to[switch=$s_2$]
                (5,4)   to[switch=$s_3$]
                (5,2)   to[switch=$s_4$]
                (5,0)  --
                (1,0)


        %Draw Capacitors
                (5,2) --
                (3,2) to[pC,l_=$c_{1}$]
                (3,6)--
                (5,6)

                (5,0) --
                (7,0) to[pC,l=$c_{2}$]
                (7,4)--
                (5,4)

        %%Sink load
                (7,4) --
                (9,4) to[I,l=$i_{out}$]
                (9,0) --
                (7,0);

        \end{circuitikz}
        \caption {Load modeled as a current sink.}
        \label{fig:isink_load}
    \end{subfigure}
\caption {Different load models for the charge flow analysis.  }
\label{fig:loads}
\end{figure}

These simplifications reduce the usability of the model to the specific application of dc-to-dc conversion, and at the same time limit the flexibility to model different concepts of the SCC, such as the aforementioned hybrid concept. In order to overcome these limitations, the presented methodology makes two different assumptions:
\begin{enumerate}
  \item The load is assumed to be a constant current source with a value equal to the average load current, as shown in Figure~\ref{fig:isink_load}. In fact, using such approach the charge delivered to the load can be evaluated for each switching phases $j$ as
      \begin{equation}
        q_{out}^j = D^j \frac{i_{out}}{f_{sw}} = D^j i_{out}{T_{sw}}  = D^j q_{out}.
      \label{eq:q_out}
      \end{equation}

  \item Any of the converter nodes can be loaded. Since the load is modeled as a current sink, it can be now connected to any of the converter's nodes without fixing a voltage at the node.

\end{enumerate}


\subsection{Re-formulating the charge flow analysis}

The equivalent impedance encompasses the root losses produced in a SCC due to capacitor charge transfer and charge conduction. As aforementioned, the classical charge flow methodology assumes an infinitely large output capacitance connected to a \emph{dc}-node, producing inaccuracy in the prediction of the equivalent output impedance when the output capacitor is comparable in value to the flying capacitors~\cite{2013Breussegem:c_out}. The root cause of this inaccuracy relies in the wrong quantification of the flow of  charges that produces losses in the converter.\\

\begin{figure}[!h]
\centering
\ctikzset { bipoles/length=1cm}
\begin{subfigure}[t]{.4\textwidth}
    %\centering
    \raggedright
    \begin{circuitikz} [american,scale=0.65]
    \draw
        (0,0) to[V=$v_{src}$] (0,3)
        (3,3) to[pC,l=$c_1$] (0,3)
        (3,0) to[pC,l=$c_2$] (3,3) -- (6,3)
        (6,0) to[pC,l=$c_3$] (6,3) --
        (8,3) to[I,l=$i_o$] (8,0) -- (0,0);
    \begin{scope}[>=latex,thick,text=black]
        \draw [->,rounded corners=7pt,dashed]
            (0.4,2.4) -- (2.4,2.4) -- (2.4,0.4);
        \draw [->,rounded corners=7pt,dashed]
            (3.6,0.5) |- (5.4,2.7) -- (5.4,0.4);
        \draw [->,rounded corners=7pt]
             (6.3,2) |- (8,3.3);
        \draw [>=latex,text=black,dashed]
          (0,4)  -- (0.9,4) node[anchor=west]{Redistributed charge};
        \draw [>=latex,text=black]
          (0,4.5)  -- (0.9,4.5) node[anchor=west]{Pumped charge};
    \end{scope}
    \end{circuitikz}
    \caption{}
\end{subfigure}
\hfill
\hfill
\begin{subfigure}[t]{.4\textwidth}
    %\centering
    \raggedleft
    \begin{circuitikz} [american,scale=0.65]
    \draw
        (1,0) to[V=$v_{src}$] (1,3)
        (6,3) to[pC,l=$c_2$] (3,3)
        (3,0) to[pC,l=$c_1$] (3,3)
        (6,0) to[pC,l=$c_3$] (6,3) --
        (8,3) to[I,l=$i_o$] (8,0) -- (1,0);
    \begin{scope}[>=latex,thick,text=black]
        \draw [->,rounded corners=7pt,dashed]
            (3.6,0.5) |- (5.4,2.4) -- (5.4,0.4);
        \draw [->,rounded corners=7pt]
            (6.3,2) |- (8,3.3);% -- (8.6,0.4);

    \end{scope}
    \end{circuitikz}
    \caption{}
\end{subfigure}
\caption{Charge flows in a Dickson 3:1 converter when loaded at a \emph{dc}-node with a large capacitor during the two switching phases. }
\label{fig:charge_flow_I}
\end{figure}

Looking in detail the flow of charges in a SCC, we can see that the capacitors of a SCC have two different flows of charge during each circuit mode:
\begin{description}

  \item[Redistributed charge] flows between the capacitors in order to equalize the different voltages, and is the charge flow that produces losses. Therefore capacitor charge losses can be evaluated by quantifying this charge flow.

      This charge flow is associated with a charge or discharge of the capacitors, happening right after the switching event and lasting for a short period of time\footnote{The duration of the charge depends on the time constant of the associated R-C circuit.}.

  \item[Pumped charge] flows from the capacitors to the load, this charge is consumed by the load, hence producing useful work.  This charge delivery is associated with a discharge of the capacitors and last for the entire period.

\end{description}
Actually, we can also define a theoretical third charge flow, which is necessary to solve the converter:
\begin{description}

  \item[Net charge] flow is quantified based on the principle of \emph{capacitor charge balance} for a converter in steady state. Based on that principle all \emph{net} charges in the capacitors can be obtained applying KCL, but using charges instead of currents. Therefore, the circuit can be solved for the \emph{net} charges flow applying
      the \emph{capacitor charge balance} as 
      \begin{equation}
       \forall~c_{i} : \sum_{j=1}^{phases}q_{i}^j = 0,
      \label{eq:charge_balance}
      \end{equation}

     The resulting charges are then gathered in the charge flow vector $\mathbf{a}$ as
       \begin{equation}
        \mathbf{a}^j =  \left[ a_{in}^j~a_1^j~a_2^j \cdots a_n^j \right] = \frac{\left[ q_{in}^j~q_1^j~q_2^j \cdots q_n^j \right]}{q_{out}},
      \label{eq:a_vector}
      \end{equation}
    where the superindex denotes the $j$-th phase, $q_{in}$ is the charge supplied by the voltage source and $q_i$ is the \emph{net} charge flowing in the $i$-th capacitor $c_i$. Notice that the vector is normalized with respect to the output charge $q_{out}$.

\end{description}


The loss mechanisms of the converters can be better understood based on these two different charge flows. For instance Figure~\ref{fig:charge_flow_I} shows the charge flows for a 3:1 Dickson converter with a infinitely large output capacitor $c_3$. In such converter, the charge flow through capacitors $c_1$ and $c_2$ is always redistributed towards the big capacitor $c_3$ and only the capacitor $c_3$ will supply charge to the load. Hence the transported charge in $c_1$ and $c_2$ is producing losses and never supplying the load. However, for a finite value of the output capacitor, or for converters loaded from an internal node, all of the capacitors contribute to pumping charge to the load~\cite{2013Breussegem:c_out}.

\begin{figure}[!h]
\centering
\ctikzset { bipoles/length=1cm}
\begin{subfigure}[t]{.4\textwidth}
    %\centering
    \raggedright
    \begin{circuitikz} [american,scale=0.65]
    \draw
        (0,0) to[V=$v_{src}$] (0,3)
        (3,3) to[pC,l=$c_1$] (0,3)
        (3,0) to[pC,l=$c_2$] (3,3) -- (6,3)
        (6,0) to[pC,l=$c_3$] (6,3) --
        (8,3) to[I,l=$i_o$] (8,0) -- (0,0);
    \begin{scope}[>=latex,thick,text=black]
        \draw [->,rounded corners=7pt,dashed]
            (0.4,2.4) -- (2.4,2.4) -- (2.4,0.4);
        \draw [->,rounded corners=7pt,dashed]
            (3.6,0.5) |- (5.4,2.7) -- (5.4,0.4);

        \draw [->,rounded corners=7pt]
            (2,3.3) -- (7,3.3)
            (2.7,2) |- (7.5,3.3)
            (6.3,2) |- (8,3.3);
        \draw [>=latex,text=black,dashed]
          (0,4)  -- (0.9,4) node[anchor=west]{Redistributed charge};
        \draw [>=latex,text=black]
          (0,4.5)  -- (0.9,4.5) node[anchor=west]{Pumped charge};
    \end{scope}


    \end{circuitikz}
    \caption{}
\end{subfigure}
\hfill
\hfill
\begin{subfigure}[t]{.4\textwidth}
    %\centering
    \raggedleft
    \begin{circuitikz} [american,scale=0.65]
    \draw
        (1,0) to[V=$v_{src}$] (1,3)
        (6,3) --  (3,3)
        (3,0) to[pC,l=$c_1$] (3,3)
        (6,0)-- (6,0.25) to[pC,l=$c_3$] (6,1.5) to[pC,l=$c_2$] (6,2.75) |-
        (8,3) to[I,l=$i_o$] (8,0) -- (1,0);
    \begin{scope}[>=latex,thick,text=black]
        \draw [->,rounded corners=7pt,dashed]
            (3.6,0.5) |- (5.4,2.7) -- (5.4,0.4);
        \draw [->,rounded corners=7pt]
             (2.7,2) |- (7.5,3.3)
             (6.3,2.5) |- (8,3.3);% -- (8.6,0.4);
    \end{scope}
    \end{circuitikz}
    \caption{}
\end{subfigure}
\caption{Charge flows in a Dickson 3:1 converter when loaded at one of the \emph{pwm}-nodes during the two switching phases. }
\label{fig:charge_flow_II}
\end{figure}

In another scenario, the one of Figure~\ref{fig:charge_flow_II},  a 3:1 H-Dickson with the load connected to second ~\emph{pwm}-node and equalized capacitors. In such converter, there is a redistributed charge flow between the different capacitors and at the same time all capacitors pump charge towards the load. Hence all the capacitors contributing in the charge delivery to the load.

In fact, the original analysis omitted the \emph{pumped} charge contribution of the flying capacitors, thereby overestimating the \emph{redistributed} charge, resulting in an overestimation of the equivalent output resistance impedance for the SSL. Therefore, in order to estimate the right output impedance, the \emph{redistributed} charge flow has to be properly quantified.\\

\begin{figure}[!h]
\centering
\input{./3_modeling/Delta_vc1.tex}
\caption{The two possible voltage waveforms that show the capacitors in a SCC. Ripples are associated with the charge flow mechanisms: top) unipolar capacitor discharge (DC capacitor); bottom) bipolar capacitor discharge (flying capacitor).}
\label{fig:cap_riples}
\end{figure}

Looking to the voltage ripple in the capacitors during a switching cycle of Figure~\ref{fig:cap_riples}, we can identify three different voltage ripples associated to the previous described charge flows:
\begin{description}
  \item[Net voltage ripple $\Delta vn$] is the voltage variation measured at the beginning and at the end of the switch events. As a matter of fact, this \emph{net} ripple can be computed from the null \emph{charge balance} in a capacitor in steady-state condition as
      \begin{equation}
        \Delta {vn}^j_i  = \frac{q_i ^j }{c_i}.
        \label{eq:net_voltage}
      \end{equation}
      Using (\ref{eq:a_vector}) the \emph{net} ripple can be formulated using the charge flow notation
      \begin{equation}
        \Delta {vn}^j_i  = \frac{a_i ^j }{c_i} {q_{out}}.
        \label{eq:net_voltage_cf}
      \end{equation}

      Notice that \emph{capacitor charge balance} principle is reflected in the \emph{net }voltage ripples of Figure~\ref{fig:cap_riples}. Thus the sum of all \emph{net} ripples of each capacitor during a switching cycle  must be zero; that is why in the two phase converter used in the example $\Delta vn^1 = \Delta vn^2$.

  \item[Pumped voltage ripple $\Delta vp$] is the voltage variation associated with the discharge of the capacitor by a constant current, thanks to assumption of modeling the load as current sink. Therefore it can be identified by the linear voltage discharge. Therefore \emph{pumped} ripple can be obtained for each $j$-th switching phase as
      \begin{equation}
        \Delta {vp}^j_i  = D^j \frac{i_i^j}{c_i }T_{sw},
      \label{eq:pumped_voltage}
      \end{equation}
      where $i_i^j$ is the current flowing through the $i$-th capacitor $c_i$. In fact, the current flowing in each individual capacitor $c_i$ during each phase $j$ can be expressed as function of the output current by solving the network of capacitors associated to the circuit of each mode, thus
      \begin{equation}
        i_i^j = b_i^j i_{out} ,
      \label{eq:b_cnst}
      \end{equation}
      where $ b_i^j $ is a constant coming from solving the capacitor network.  Replacing (\ref{eq:b_cnst}) and (\ref{eq:q_out}) into (\ref{eq:pumped_voltage}), the \emph{pumped} voltage ripple can be expressed in the charge flow notation as
      \begin{equation}
        \Delta {vp}^j_i  = D^j \frac{b_i^j}{c_i } {i_{out}} {T_{sw}} = D^j \frac{b_i^j}{c_i } {q_{out}}.
      \label{eq:pumped_voltage_cf}
      \end{equation}
      
      Like in the previous case with the \emph{net} charge flow, the $b_i^j$ elements are gathered in the \emph{pumped} charge flow vector $\mathbf{b}$ as
      
      \begin{equation}
        \mathbf{b}^j =  \left[ b_1^j~b_2^j \cdots b_n^j \right] = \frac{\left[ ~i_1^j~i_2^j \cdots i_n^j \right]}{i_{out}},
      \label{eq:b_vector}
      \end{equation}
      
      where the superindex denotes the $j$-th phase, $i_i$ is the \emph{pumped} current flowing in the $i$-th capacitor $c_i$; the vector is normalized with respect to the output current $i_{out}$. Notice that the vector is dual for currents or charges. 
      

  \item[Redistributed ripple $\Delta vr$ ]is the voltage variation associated with an exponential charge or discharge transient caused by a charge redistribution between capacitors and it happens just right after a phase transition event. The \emph{redistribution} ripple can be quantified by the addition of the two previous ripples as
      \begin{equation}
        \Delta {vr}^j_i  = {vn}^j_i + {vp}^j_i .
      \label{eq:rdst_ripple_I}
      \end{equation}
      Substituting (~\ref{eq:net_voltage_cf}) and (\ref{eq:pumped_voltage_cf}) into (\ref{eq:rdst_ripple_I}) the \emph{redistributed} ripple is formulated in terms of the charge flow analysis, as 
      \begin{equation}
        \Delta {vr}^j_i  = \frac{q_{out}}{c_i} \left[ a^j_i - D^j b^j_i \right] .
      \label{eq:rdst_ripple_II}
      \end{equation}
      
      
\end{description}


\subsubsection[SSL]{Slow Switching Limit Equivalent Output Resistance}

The SSL equivalent output resistance $r_{ssl}$ accounts for the losses produced by the capacitor charge transfer, therefore $r_{scc}$ can be obtained evaluating the losses in the capacitors.  The energy lost in a charge or discharge of a capacitor is given by
\begin{equation}
E_{loss}=\frac{1}{2}{{\Delta{v}}_c}^2 c.
\label{eq:e_lost}
\end{equation}
where $\Delta v_c$ is the voltage variation in the process. Previously, we defined that the \emph{redistributed} ripple is associated to the capacitor charge transfer, thus by substituting (\ref{eq:rdst_ripple_II}) into (\ref{eq:e_lost}) we obtain the losses due to capacitor charge transfer 
\begin{equation}
E_i^j=\frac{1}{2}{({\Delta{vr}}_i^j)}^2C_i=\frac{1}{2}\frac{{q_{out}}^2}{{c_i}^2}{\left[a_{i\
}^j-{D^j} {b_i^j}\right]}^2c_i=\frac{1}{2}\frac{{q_{out}}^2}{c_i}{\left[a_{i\
}^j-{D^j} {b_i^j}\right]}^2 .
\label{eq:e_lost_ssl}
\end{equation}
The total power loss in the circuit is the sum of the losses in all of the
capacitors during each phase multiplied by the switching frequency$f_{sw}$.
This yield{\small s}
\begin{equation}
P_{ssl}= f_{sw} \sum_{i=1}^{caps.}\sum_{j=1}^{phases} E_i^j =\frac{f_{sw}{q_{out}}^2}{2}\sum_{i=1}^{caps.}\sum_{j=1}^{phases}\frac{1}{c_i}{\left[a_{i\
}^j-{D^j}{b_i^j}\right]}^2.
\label{eq:pwr_ssl}
\end{equation}

The losses can be expressed as the output SSL impedance by dividing~\ref{eq:pwr_ssl} by the
square of the output current as
\begin{equation}
r_{ssl}=\frac{P_{ssl}}{{i_o}^2}=\frac{P_{ssl}}{{(f_{sw} {q_{out}})}^2}=\frac{1}{2 f_{sw}}\sum_{i=1}^{caps.}\sum_{j=1}^{phases}\frac{1}{c_i}{\left[a_{i\
}^j-{D^j} {b_i^j}\right]}^2.
\label{eq:r_ssl}
\end{equation}


\subsubsection[FSL]{Fast Switching Limit}
The fast switching limit (FSL) equivalent output resistance ($r_{fsl}$) accounts for losses produced in the resistive circuit elements, being these the \emph{on}-resistance of the switches and the Equivalent Series Resistance (ESR) of the capacitors $r_{esr,c}$. As outlined in~\cite{Seeman:EECS-2009-78}, the charge flow vectors through the parasitic resistive elements $\mathbf{ar}$ can be derived using the charge flow vectors $\mathbf{a}$, then $r_{fsl}$ is computed as 
\begin{equation}
r_{fsl}=\sum_{i=1}^{elm.}\sum_{j=1}^{phases}\frac{r_i}{D^j}{{ar}_{i\ ^j}}^2,
\label{eq:r_ssl}
\end{equation}
where $r_i$ is the resistance value of the $i$-th element with a flowing charge $ar_i$.  


\subsubsection{Equivalent Switched Capacitor Converter Resistance}
With the goal of obtaining a simple design equation, an analytical approximation of $r_{scc}$ suggested in~\cite{1998Arntzen,1999Maksimovic}, is given by
\begin{equation}
r_{scc} \approx \sqrt{{r_{ssl}}^2+{r_{fsl}}^2},
\label{eq:r_scc}
\end{equation}
and it used in all the presenter results from this dissertation. Nevertheless, a recent publication~\cite{2012Makowski} claimed a \emph{better} approximation as
\begin{equation}
r_{scc,bis} \approx \sqrt[\leftroot{-3}\uproot{3} u]{{r_{ssl}}^{u}+{r_{fsl}}^{u}},
\label{eq:r_scc_II}
\end{equation}
where $u = 2.54$. The value of factor $u$ comes from an approximation from the exact formula of the output for a single lossy capacitor operating with a duty cycle of $0.5$, however it becomes worst than the original approximation for duty cycles different of $0.5$ or for converters with different time constants between phases. A slightly better accuracy is e obtained with readjustment of the $u$ factor with the duty cycle $D$ obtained given by
\begin{align}
p & = \frac{1}{2} \left[ \frac{e^{\frac{1}{D}+1}}{e^{\frac{1}{D}-1}} + \frac{e^{\frac{1}{1-D}+1}}{e^{\frac{1}{1-D}-1}} \right], 
\\
\\
u &= \frac{1}{\log_2 p}.
\label{eq:u_factor}
\end{align}
showing better results in converters with similar time constants between phases. In circuits with very different time constants between phases non of the approximations shows a better results in for the whole range of $D$ that are conclusive to favour the use.

\subsubsection{Conversion ratio}

The conversion ratio of the converter can be obtained with the source \emph{net} charge element from vector $\mathbf{a}$ as
\begin{equation}
m(D^j)=\frac{{v_{trg}}}{v_{src}}=\sum_{j=1}^{phases}a_{in}^j.
\label{eq:r_ssl}
\end{equation}
where $a_{in}$  corresponds to the input voltage source term of the charge
vector multiplier $\mathbf{a}$.

\section{Multiple Output Converter}


\subsection{The Output Trans-Resistance Model}
\subsection{Obtaining the Trans-Resistance parameters with the charge flow analysis }




\clearpage
\bibliographystyle{plainnat}
\bibliography{references} 