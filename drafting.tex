Currently driver architectures are based on discrete implementations. The driver circuits are composed by discrete components all assembled on a single \emph{printed-circuit-board} (PCB), enabling a fast development and cheap costs. Generally the mounted parts are cheap general propose components sold by millions. However this design approach has some limitations. First the mounted performance of old and cheap components restricts the volume reduction of the required  passive components in the drivers filters and magnetics. Second, as the circuit increases in complexity, the \emph{bill of materials} (BOM) and there fore the costs increases, also the costs, therefore reducing the possibilities to offer more functionality in the driver circuit, such as connectivity and controllability at reduced costs. In resume, fulfilling the driver requirements for the second generation of LED lamps will be very challenging using the current discrete driver  architectures.

For the past years cost down reduction has enabled to bring the prices for simple \emph{retrofitted} lamps down to competitive levels. However the chosen circuit architectures for low cost drivers are very cost sensitive towards more intelligent drivers, as it can be seen with the different prices for the \emph{dimmable}, \emph{non-dimmable} and \emph{smart} lamps of  Table~\ref{tab:lighting_tech}. That is why a different approach in the driver architectures must be taken in order to respond to the challenges for the future intelligent and connected LED lamps. In other words, the driver architecture that will provide power management, intelligence and connectivity together, assembled in a reduced volume, and at low cost will be, with no discussion, the key element to carry the future of LED lighting technology.




Besides looking for higher the size reduction that an integrated driver would offer, such an approach would also bring other benefits in terms of control and connectivity.  The power management unit and driver control unit could be integrated together, providing the necessary intelligence for light control and the connectivity optimized for the requirements of the coming connected lighting industry. \emph{Smart lamps} are a clear example of the requirements of the so called \emph{smart drivers}. The \emph{smart lamps} are wireless connected to a network providing remote control for the light intensity level and color from a web interface, a mobile application or a dedicated remote control. The internal electronics has normally four LED drivers - one per each color channel: red, green, blue and amber - and, at the same time, a wireless interface. The electronic board is populated with discrete power drivers and micro-controller units. A solution capable to integrate all the functions in a single IC, or few ICs (one per channel), will definitely reduce packaging and assembling costs and still providing the same functionality. At the same time, the expected market volume for SSL technologies will, with no doubt,  justify costs of a dedicated ASIC design for LED drivers. All-in-all it has been the goal of this PhD thesis with the goal to explore and identify new architectures suitable for  integration that can efficiently power LEDs. The rational to explore the architectures that enable high density highly miniaturized power LED drivers, such as switched capacitor converters, developing a design framework based on a model-centric approach.


Settling the goal in providing new driver circuits that that are more suitable for integration, than the currently available. And with the vision that integrable drivers will help in further development of more functionalities within the same package.

 h from the perspective of the integrated power supplies brings the focus of the research to drivers where the power converter can be partially or fully integrated in a single package. There are two approaches of integrated power converters: \emph{Power System on Chip} (PSoC) or  \emph{Power System in Package} (PSiP). The first integrates all required power components, active and passive, on a single die. The second assembles all the components within the same package, keeping the appearance of an unique \emph{Integrated Circuit} (IC), see Figure~\ref{fig:psoc_example}. The advantages of having an integrated power management unit align with the necessities of the LED drivers, therefore the trend of the drivers will be going towards having \emph{Power LED Drivers in Package} (PLDiP).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%       CHAPTER 2: Miniaturization in LED drivers     %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Intro paragraph
Screen backlighting, Automotive and General Lighting are currently the three main areas of application of LEDs. Based on them we provide a broad overview about the state-of-the-art

Currently there is any commercial IC that solves the challenges of the smart drivers, offering connectivity and power management.

the most innovative approach is taken by the startup \emph{Gooee} that proposes connected lighting platform consisting   of two ICs. The control chip integrates a micro-controller unit (MCU) with to implement the communication and sensing, and the power chip with the LED driver that interfaces with the LED; the platform  is completed with a cloud service that enables from a web application to have access to the lamp fixture data logs. The technical details of the power chip are no yet available~\cite{web:Gooee}.

\begin{circuitikz} [scale=0.65]
    \begin{scope}[xshift = 10cm, yshift=0cm]
            \draw[->] (0,0) -- (4,0) node[anchor=south west] {$  m $};
            \draw[->] (0,0) -- (0,3.2) node[anchor=east] {$\eta $};

            %Ticks X
            \draw  (1.75,5pt) -- (1.75,0pt) node[anchor=south west ] {$m_1$};
            \draw  (3,5pt) -- (3,0pt)   node[anchor=south west ] {$m_2$};
            %\draw (1.5,2pt) -- (1.5,-5pt) node[anchor=north] {$0.7$};

            %Ticks Y
            \draw (2pt,2.5) -- (-5pt,2.5) node[anchor=east] {$100\%$};
            \draw (2pt,1.5) -- (-5pt,1.5) node[anchor=east] {$90\%$};

            %Markers
            \draw[dotted] (1.75,2.4) -- (1.75,0);
            \draw[dotted] (3,2.3) -- (3,0);
            \draw[dotted] (3,2.5) -- (0,2.5);
            %\draw[dotted] (1.5,1.5) -- (1.5,0);
            %\draw[dotted] (1.5,1.5) -- (0,1.5);


            \draw[thick] (0.5,1.4) -- (1.75,2.4) -- (1.75,1.6) -- (3,2.3)  node[anchor=south] {};
            \draw (10,0)[anchor=north] {};
        \end{scope}
    \end{circuitikz}












to explore as a solution for a \emph{Power System on-Chip/in-Package} LED driver.  Exploring the possibilities that switched capacitor converters can offer in terms of integrated and miniaturized LED drivers with efficient voltage-to-current conversion was the rational of this dissertation.



  Due to the limitations of SCC  in voltage-to-current conversion would directly disqualify them. However their advantageous characteristics form the standpoint of view of integration, made these circuits very attractive.

Based on the aforementioned arguments both SMPS technologies, inductor based and switched capacitor converters,   are the most suitable  for high efficient LED drivers and miniaturization. On the one hand, inductive converters are the preferred choice due to their high efficiency and regulation capabilities, although they are less suitable to integrate due to the use of adopting a


The use of a bear SCC can never satisfy the requirements of LED drivers due to the following facts:
\begin{itemize}
  \item Only provide voltage-to-voltage conversion
  \item Fixed conversion ratios
  \item Regulation is provided by series shunting
\end{itemize}
These limitations combined with the abrupt characteristics I-V of the LEDs makes barely impossible to provide high efficient solutions with the single use of SCC. The converters would require to have a large number of conversion ratios with a very large granularity to avoid uncontrolled currents flowing through the LEDs.

The research presented in this work aims to explore the possibilities of the SCC for LED drivers and the conducting path is based in the combination of the with inductors. The overall solution improves the power density and reduced form factor of the present solutions.


This thesis is divided in the four main sections that where necessary to build a switched capacitor LED driver. The first section introduces the new LED driver architecture used during the entire thesis, the \emph{Hybrid-Switched Capacitor Converter}, H-SCC from now on. The second part of this book, the core of the PhD. work, presents the methodology to model H-SCC. The methodology extends the previous works in the topic providing an enhanced modeling for the design of SCCs and H-SCCs. The third section is devoted to the practical use of the new methodology, thus for the design phase of a converter. The modeling is used  to help in the development facilitating the sizing and optimization of the design variables. The last section presents a discrete implementation of 12W H-SCC LED driver and the design procedure. Although is not a regular practice, experimental work is not only presented in the in the last section. The experimental work has been also  used to validate the presented modeling and methodology. The final section is the conclusion of the entire work and the future opportunities that the presented work can offer.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%               CHAPTER 3: H-SCC                      %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Equal voltage ripple among all \emph{pwm}-nodes.

Actually using the \emph{pwm}-nodes of an SCC reduces the amplitude of the voltage ripple at the filter inductor, what at the same time requires a smaller inductor value for a converter operating under the same frequency and current ripple conditions. The reduction ratio of the inductor can be obtained from eqs. (\ref{eq:buck_l}) and (\ref{eq:hscc_l}) as
\begin{equation}
 \frac{l_{o,hscc}}{l_{o,buck}} =  \frac{{ m_i \cdot v_{src} \cdot DD' \cdot T}/{\Delta i} }{{  v_{src} \cdot DD' \cdot T}/{\Delta i}} = m_i.
\label{eq:l_m}
\end{equation}
In fact, the ratio coincides with the intrinsic conversion ratio ($m_i$) of the converter, which for a step-down is always smaller than 1. For the 3:1 Dickson H-SCC of figure~\ref{fig:3_1_hscc} the inductor value is 3 times smaller than in a buck converter. As a matter of fact, using an H-SCC introduces an new design parameter to reduce the value of the power inductor, providing a new architecture that improves the integration or power converters in this case by the reduction of the magnetic components.


As a general practice in the design of a LED driver, the voltage of
the LED string is often optimized by selecting low, mid or high
power LEDs and wiring them in series or parallel. It is favorable
to select a high voltage in the LED strings, but small enough to be
driven by a buck converter. Increasing the voltage in the LED
string decreases currents through the converter reducing the
conduction losses.

%%%%%%%%%%%%%%%%%%%%%
% Voltages L.S.
%%%%%%%%%%%%%%%%%%%%%
\begin{align}
\begin{split}
  v_{src} - v_{c_1} - v_{c_2} &=0, \\
  v_{c_1} - v_{c_2} - v_{c_3} &=0, \\
  v_{out} - v_{c_2}  &=0,\\
  v_{out} - v_{c_3}  &=0,
\end{split}
\end{align}

%%%%%%%%%%%%%%%%%%%%%%%
% Multi-ratio converter
%%%%%%%%%%%%%%%%%%%%%%%

\begin{figure}[!h]
    \centering
    \begin{subfigure}{0.45\textwidth}
        \ctikzset { bipoles/length=1cm}
        %\centering
        \raggedleft
        \begin{circuitikz} [american,scale=0.65]
        %\draw (0,7) node[anchor=south] {};
        \draw
            (0.5,-4) node[sground] {} to[V = $v_{src}$] (0.5,-2)
            (0.5,3) to[switch=$s_1$]
            (2.5,3) to[capacitor=${c_1}$]
            (3.5,3) -- (5,3) to[switch=$s_2$]
            (6.5,3);

        %Switch s9
        \draw (4,3) -- (4,1.5) to[switch=$s_9$] (2,1.5) -- (2,-2);

        %Switch s4
        \draw (5,3)  to[switch=$s_4$] (5,1.5) node[sground] {} ;

        %Switch branch to load
        \draw (2,3) --
              (2,4.5) to[switch=$s_3$]
              (6.5,4.5) -- (6.5,-2);

        \draw (0.5,3) -- (0.5,-2) to[switch=$s_5$] (2,-2) -- (2.5,-2) to[capacitor=${c_2}$] (3.5,-2) -- (4,-2) to[switch=$s_6$] (6.5,-2);

        %Switch s7
        \draw (2,-0.5) to[switch,l^=$s_7$] (6.5,-0.5);

        %Switch s8
        \draw (4,-2)  to[switch,l_=$s_8$] (4,-4) node[sground] {} ;


        %Load and capacitor C2
        \draw (6.5,-4) node[sground]{} to[capacitor,l_=$c_o$] (6.5,-2);

        \draw (6.5,-2) to[short,-o] (7.5,-2) node[anchor=west] {$v_o$};

        \end{circuitikz}
        \caption{Multiple conversion ratio SCC.}
        \label{fig:M_SCC_ckt}
    \end{subfigure}
    \begin{subfigure}{0.45\textwidth}
        %\centering
        \raggedright
        \begin{circuitikz}
            \begin{scope}[xscale=0.75, yscale=0.85]
            \draw (0,4.5) node[anchor=south] {};
            \draw[->] (0,0) -- (7,0) node[anchor=south] {$  m_e $};
            \draw[->] (0,0) -- (0,4) node[anchor=east] {$\eta $};

            %Ticks X
            \draw (6,2pt) -- (6,-5pt)  node[anchor=north  ] {$1$};
            \draw (3,2pt) -- (3,-5pt)   node[anchor=north ] {$\frac{1}{2}$};
            \draw (4,2pt) -- (4,-5pt)   node[anchor=north ] {$\frac{2}{3}$};
            \draw (2,2pt) -- (2,-5pt)   node[anchor=north ] {$\frac{1}{3}$};
            \draw (0,0) node[anchor=north east] {$0$};

            %Ticks Y
            \draw (2pt,3) -- (-5pt,3) node[anchor=east] {$100\%$};
            \draw (2pt,1.5) -- (-5pt,1.5) node[anchor=east] {$50\%$};

            %Markers
            \draw[dotted] (6,3) -- (6,0);
            \draw[dotted] (6,3) -- (0,3);
            \draw[dotted] (3,3) -- (3,0);
            \draw[dotted] (3,1.5) -- (0,1.5);


            \draw[thick,dashed] (6,3) -- (0,0);
            \draw[thick] (0,0)--(2,3)--(2,2) -- (3,3) -- (3,2.25) -- (4,3) -- (4,2) -- (6,3);

             \draw[thick] (0.75,4) -- (1.25,4) node[anchor=west] {Linear regulator};
            \draw[thick,dashed] (0.75,3.5) -- (1.25,3.5) node[anchor=west] { Multi-target SCC};
        \end{scope}
    \end{circuitikz}
        \caption{Maximum theoretical efficiency.}
        \label{fig:M_SCC_plt}
    \end{subfigure}
\end{figure}

\begin{figure}
    \ctikzset { bipoles/length=1cm}
    \centering
    %\raggedleft
    \begin{circuitikz} [american,scale=0.65]
    %\draw (0,7) node[anchor=south] {};
    \draw
        (0.5,-4) node[sground] {} to[V = $v_{src}$] (0.5,-2)
        (0.5,3) to[switch=$s_1$]
        (2.5,3) to[capacitor=${c_1}$]
        (3.5,3) -- (5,3) to[switch=$s_2$]
        (6.5,3);

    %Switch s9
    \draw (4,3) -- (4,1.5) to[switch=$s_9$] (2,1.5) -- (2,-2);

    %Switch s4
    \draw (5,3)  to[switch=$s_4$] (5,1.5) node[sground] {} ;

    %Switch branch to load
    \draw (2,3) --
          (2,4.5) to[switch=$s_3$]
          (6.5,4.5) -- (6.5,-2);

    \draw (0.5,3) -- (0.5,-2) to[switch=$s_5$] (2,-2) -- (2.5,-2) to[capacitor=${c_2}$] (3.5,-2) -- (4,-2) to[switch=$s_6$] (6.5,-2);

    %Switch s7
    \draw (2,-0.5) to[switch,l^=$s_7$] (6.5,-0.5);

    %Switch s8
    \draw (4,-2)  to[switch,l_=$s_8$] (4,-4) node[sground] {} ;


    %Load and capacitor C2
    \draw (6.5,-4) node[sground]{} to[capacitor,l_=$c_o$] (6.5,-2);

    \draw (6.5,-2) to[short,-o] (7.5,-2) node[anchor=west] {$v_o$};

    \end{circuitikz}
    \caption{Multiple conversion ratio SCC.}
    \label{fig:M_SCC_ckt}
\end{figure}

\begin{figure}[!h]
    \centering
    %\raggedright
    \begin{circuitikz}
        \begin{scope}[xscale=0.9, yscale=0.85]
        \draw (0,4.5) node[anchor=south] {};
        \draw[->] (0,0) -- (7,0) node[anchor=south] {$  m_e $};
        \draw[->] (0,0) -- (0,4) node[anchor=east] {$\eta $};

        %Ticks X
        \draw (6,2pt) -- (6,-5pt)  node[anchor=north  ] {$1$};
        \draw (3,2pt) -- (3,-5pt)   node[anchor=north ] {$\frac{1}{2}$};
        \draw (4,2pt) -- (4,-5pt)   node[anchor=north ] {$\frac{2}{3}$};
        \draw (2,2pt) -- (2,-5pt)   node[anchor=north ] {$\frac{1}{3}$};
        \draw (0,0) node[anchor=north east] {$0$};

        %Ticks Y
        \draw (2pt,3) -- (-5pt,3) node[anchor=east] {$100\%$};
        \draw (2pt,1.5) -- (-5pt,1.5) node[anchor=east] {$50\%$};

        %Markers
        \draw[dotted] (6,3) -- (6,0);
        \draw[dotted] (6,3) -- (0,3);
        \draw[dotted] (3,3) -- (3,0);
        \draw[dotted] (3,1.5) -- (0,1.5);


        \draw[thick,dashed] (6,3) -- (0,0);
        \draw[thick] (0,0)--(2,3)--(2,2) -- (3,3) -- (3,2.25) -- (4,3) -- (4,2) -- (6,3);

         \draw[thick] (0.75,4) -- (1.25,4) node[anchor=west] {Linear regulator};
        \draw[thick,dashed] (0.75,3.5) -- (1.25,3.5) node[anchor=west] { Multi-target SCC};
    \end{scope}
\end{circuitikz}
\caption{Maximum theoretical efficiency.}
\label{fig:M_SCC_plt}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%       Power switches
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
$ P_{sw}$ &  $ \frac{4+N}{8 \cdot N^2} \cdot v_{vin}^2 \cdot f_{sw}  \cdot {c_{ds}} $ &  $ \frac{1}{ N} \cdot v_{src}^2 \cdot f_{sw} \cdot {c_{ds}} $  \\
 $ \frac{P_{sw}}{P_{sw,buck}}$ &  $ \frac{4+N}{8 \cdot N^2}  $ &  $ \frac{1}{ N}  $  \\

Table ~\ref{tab:3:1 H-Dick_V_stress} shows the blocking voltages of the switches of the 3:1 H-Dickson of Figure~\ref{fig:3_1_hscc}.

%%%%%%%%%%%%%%
% LED driver
%%%%%%%%%%%%%


%\subsection{High Current Paths} %\label{sc:high_current_path} %
%The current % %\begin{figure}[t] %\ctikzset { bipoles/length=1cm}
%\centering % \begin{circuitikz}[american voltages,scale=0.6] % %
\draw % %Input Supply % (0,0) to[V=$v_{src}$] % %Draw Switches %
(0,10) -- % (5,10) to[switch=$s_1$,-*] %S1 % (5,8) to[switch=$s_2$]
%S2 % (5,6) to[switch=$s_3$] %S3 % (5,4) -- % %left branch % (3,4)
to[switch=$s_5$] % (3,2) to[switch=$s_4$] % (3,0); % % \draw %right
branch % (5,4) -- % (7,4) to[switch,l_=$s_6$] % (7,2)
to[switch,l_=$s_7$] % (7,0) -- (0,0); % % % % \draw %Capacitor C1 %
(3,2) -- (2,2) % to[pC,l_=$c_1$] (2,8) -- % (5,8); % % \draw
%Capacitor C2 % (7,2) -- % (8.25,2) to[pC,l_=$c_2$](8.25,6) -- %
(5,6); % % \draw %Inductor % (5,8) -- (8,8) node[anchor=south]
{$v_x$} to[L=$l_o$] (12,8) % (12,6) node[sground] {}
to[pC,l=$c_{o}$] (12,8) % (12,8) -- (14,8) to[leD*] (14,6) % (14,5)
to[leD*] (14,3) node[sground]{} % (14,9) to[open,v^=$v_o$] (14,2);
% % \draw[dotted] (14,6) -- (14,5); % % % \draw %Capacitor C3 %
(5,0) to[pC,l_=$c_3$,-*] (5,4) node[anchor=south east] {}; % % %
Draw currents flow arrows % % Ph1 % \draw[thick,->] (0.25,6) --
(0.25,8.75) to[bend left=45] (1.25,9.75) -- (3.75,9.75) % to[bend
left=45] (4.75,8.75) to[bend right = 45] (5.75,7.75) -- (7.5,7.75);
% % \draw[thick] (2.25,5.5) -- (2.25,6.75) to[bend left=45]
(3.25,7.75) -- (7,7.75) ; % % %Ph 2 % \draw[thick, dashed,->]
(1.75,5.5) -- (1.75,7.75) to[bend left=45] (2.25,8.25) --
(7.5,8.25) ; % \draw[thick, dashed] (4.75,6.25) -- (4.75,7.25)
to[bend left=45] (5.75,8.25) ; % % \end{circuitikz} % \caption{
H-SCC with a 3:1 Dickson topology with the inductor connected to
the second \emph{pwm}-node.} % \label{fig:3_1_hscc} %\end{figure}\

%\begin{SCfigure} %\centering %\begin{circuitikz}[american
voltages,xscale=0.55,yscale=0.65] %\begin{scope} % \draw [->] (0,0)
-- (10,0) node[anchor=west]{$t$}; % \draw [->] (0,0) -- (0,6.5)
node[anchor=east]{$v_x$}; % % %Vertical ticks % \draw (2pt,6) --
(-5pt,6) node[anchor=east] {$v_{src} $}; % \draw (2pt,4) --
(-5pt,4) node[anchor=east] {$v_{src} \frac{2}{3}$}; % \draw (2pt,2)
-- (-5pt,2) node[anchor=east] {$v_{src} \frac{1}{3}$}; % %
%Horizontal ticks % \draw (1.25,2pt) -- (1.25,-5pt)
node[anchor=north] {$DT$}; % \draw (3,2pt) -- (3,-5pt)
node[anchor=north] {$T$}; % \draw (6,2pt) -- (6,-5pt)
node[anchor=north] {$2T$}; % \draw (9,2pt) -- (9,-5pt)
node[anchor=north] {$3T$}; % \draw (0,0) node[anchor=north east]
{$0$}; % % \draw[semithick, dashed] (0,2.1) -- (1.15,2.1) --
(1.35,3.9) -- (2.9,3.9) -- % (3.1,2.1) -- (4.15,2.1) -- (4.35,3.9)
-- (5.95,3.9) -- % (6.1,2.1) -- (7.15,2.1) -- (7.35,3.9) -- (9,3.9)
; % % \draw[semithick,dotted] (0,5.9) -- (1.15,5.9) -- (1.35,4.1)
-- (2.9,4.1) -- % (3.1,5.9) -- (4.15,5.9) -- (4.35,4.1) --
(5.9,4.1) -- % (6.1,5.9) -- (7.15,5.9) -- (7.35,4.1) -- (9,4.1) ; %
% \draw[semithick ] (0,1.95) -- (1.15,1.95) -- (1.35,0.05) --
(2.9,0.05) -- % (3.1,1.95) -- (4.15,1.95) -- (4.35,0.05) --
(5.9,0.05) -- % (6.1,1.95) -- (7.15,1.95) -- (7.35,0.05) --
(9,0.05) ; % % \draw[semithick, dashdotted ] (0,0.05) --
(1.15,0.05) -- (1.35,1.95) -- (2.9,1.95) -- % (3.1,0.05) --
(4.15,0.05) -- (4.35,1.95) -- (5.9,1.95) -- % (6.1,0.05) --
(7.15,0.05) -- (7.35,1.95) -- (9,1.95) ; % %\end{scope}
%\end{circuitikz} %\caption{Transient voltages of all the different
\emph{pwm}-nodes of the converter of figure~\ref{fig:3_1_hscc}.}
%\label{fig:vx_t} %\end{SCfigure}



%%Single output block diagram

\begin{figure}[!h]
\centering
\ctikzset { bipoles/length=1cm}
\begin{circuitikz}[scale=0.65]
\draw
    (1,0) to[short,o-]
    (0,0) to[V = $V_{supply}$]
    (0,3) to[short,-o]
    (1,3) ;

\draw
    (2,3) --
    (2.5,3)

    (2,0) --
    (2.5,0)

    node[ocirc]  (IC)  at (2,0) {}
    node[ocirc]  (I) at (2,3) {}
    (I) to[open,v=$v_{i}$] (IC);


\draw [thick]
    (2.5,-0.5) --
    (2.5,3.5)  --
    (5.5,3.5)  --
    (5.5,-0.5) --
    (2.5,-0.5);

\draw (4,2)node[anchor=north]{$\frac{v_o}{v_{i}}=m$} ;
\draw
    (5.5,3) -- (6,3)
    (5.5,0) -- (6,0)
    node[ocirc]  (O)  at (6,3) {}
    node[ocirc]  (OC) at (6,0) {}
    (O) to[open,v^<=$v_{o}$] (OC);

\draw
    (7,0) to[short,o-]
    (8,0) to[ R= $Load$,mirror]
    (8,3) to[short,-o]
    (7,3) ;
\end{circuitikz}
\label{fig:two_port}
\caption{General two port configuration of a Switched Capacitor Converter. }
\end{figure}



\begin{figure}[!h]
\centering
\ctikzset { bipoles/length=1cm}
%\ctikzset { scale=0.5}
\begin{subfigure}[t]{\textwidth}
    \centering
    %\ctikzset { bipoles/length=1cm}
        \begin{circuitikz}[american voltages,scale=0.6]
        \draw (-1,7) node[anchor=north]{ };
        \draw %Input Supply
                (-1,0)  to[V=$v_{src}$]
                %Draw Switches
                (-1,4)  --
                (4,4);

        %Capacitor C1
        \draw   (4,2) to[pC=$c_1$] (4,4);

        %Capacitor C2
        \draw (2,0)to[pC=$c_2$](2,2) --(4,2);

        %Capacitor C3
        \draw  (-1,0)--
               (6,0) to[pC=$c_3$]
               (6,2) -- (4,2);

         \draw (6,2) to[L,l=$l_o$,-o] (11,2) node[anchor=west] {};
         \draw (6,0) to[short,-o] (11,0) node[anchor=west] {};
         \draw (11,2) to[open,v^=$v_{out}$] (11,0);

         \draw (10,0) to[pC,l=$c_{o}$] (10,2);
         \draw (6,2) node[anchor=south] {$v_x$};

         \end{circuitikz}
     \subcaption{First phase, odd switches are closed and even switches are open.}
     \label{fig:hscc_full_p1}
     \end{subfigure}

\begin{subfigure}[t]{\textwidth}
      \centering
      \begin{circuitikz}[american voltages,scale=0.6]
        \draw (0,4.5) node[anchor=north]{ };
        \draw   %Input Supply
                (-1,0)  to[V=$v_{src}$]
                %Draw Switches
                (-1,4);

        \draw   (5,2) to[pC=$c_2$] (5,4);

        \draw %Capacitor C1
               (2,0)to[pC=$c_1$](2,4) --(5,4);

        \draw %Capacitor C3
               (5,0) to[pC=$c_3$]
               (5,2) -- (5,2);

         \draw (5,4) to[L,l=$l_o$,-o] (11,4) node[anchor=west] {};
         \draw (-1,0) to[short,-o] (11,0) node[anchor=west] {};
         \draw (11,4) to[open,v^=$v_{out}$] (11,0);
         \draw (10,0) to[pC,l=$c_{o}$] (10,4);

         \draw (5,4) node[anchor=south] {$v_x$};

         \end{circuitikz}
     \subcaption{Second phase, even switches are closed and odd switches are open.}
     \label{fig:hscc_full_p2}
     \end{subfigure}
\caption{The two switching modes of 3:1 H-Dickson of Figure~\ref{fig:3_1_hscc}}
\label{fig:hscc_phases}
\end{figure}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%               CHAPTER 4: MODELING                   %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%Intro

that arise with the proposed hybrid converter. First, any of the nodes of the converter are considered as possible outputs that can be loaded. Second, the analysis includes the effects of duty cycle modulation (PWM) in any of the operation regimes of the converter, which indeed affects the converter's conversion ratio and the produced losses.

%Define the two vertical regions SSL & FSL
  \vasymptote[draw=none]{1e5}{ssl};
  \vasymptote[draw=none]{1e6}{fsl};

  %Define vertical axis at zero
  \path[name path=yaxis_0] (axis cs:0,0) -- (axis cs:0,1e10);
  \path[name path=yaxis_fsl] (axis cs:1e6,0) -- (axis cs:1e6,1e10);
  \path[name path=yaxis_Inf] (axis cs:5e6,0) -- (axis cs:5e6,1e10);

  \addplot [
        thick,
        draw=none,
        fill=lightgray,
        fill opacity=0.3
    ]
    fill between[
        of = yaxis_0 and ssl,
    ];

    \addplot [
        thick,
        draw=none,
        fill=lightgray,
        fill opacity=0.3
    ]
    fill between[
        of=yaxis_fsl and yaxis_Inf,
    ];

    %\node[anchor=north,rotate=45] at (\lbssl,1/(\lbssl*\C)){$SSL$};
    %
    \node[anchor=north] at (1e6,4){$FSL$};

The \emph{solid} lines marks the pumped charge paths to the load and the \emph{dashed} lines the possible paths of the redistributed charge.

 in order to overcome the restrictions of the original charge flow methodology,

As described in the previous section, the proposed methodology models the load as a current sink instead of a voltage sink. This slight modification has a relevant change in the modeling of the converter, adding three important aspects to the modeling:
\begin{enumerate}
  \item Connect the load to any of the nodes of the converter, since it does not fix any voltage at the connected node.

  \item Include the \emph{dc}-capacitors in the analysis, since the voltage across the sink is given by the capacitor and not longer by the previous used voltage sink.

  \item Estimate the delivered charge to the load for each of the circuit modes of the converter, since the current sink has a value of the averaged output current.
\end{enumerate}


A charge multiplier vector $\mathbf{a}$ is obtained for all of the operation modes, also known as phases, of the converter. The charge multiplier vector corresponds to the charge flowing in every individual capacitor or source, normalized with respect to the total output charge $q_{out}$, as described in~\cite{95Makowski,Seeman:EECS-2009-78}. Owing to the fact that load current $i_o$ is assumed constant, the output charge of the $j$-phase can be expressed as the ratio of the phase duration $D^j$ to the total switching period $T_{sw}$, and its contribution to the total output charge $q_{out}$ is
\begin{equation}
    q^j_{out} = i_{o} T_{sw} D^j = D^j q_{out} .
\label{eq:qout}
\end{equation}

Each charge flow element $ a(D^j)_i^j$  is a function of the phase duration $D^j$ and corresponds to the total net charge circulating in the $i$-th capacitor $c_i$ during the $j$-th phase, and can be used to compute the $net$ voltage $vn$ variation at the end of the $j$-th phase period:

The current flowing through the $i$-th capacitor can be assumed to be constant, since the load has been modeled as a constant current skin. Hence the current in the $i$-th capacitor will a
Due to the approximation of constant load current, it can be assumed that in the $i$-th capacitor the charge to the load is pumped by a constant current $i_i$.

Hence the pumped voltage $vp$ variation during the $j$-th phase of the total switching period $T_{sw}$ can be simply computed as
\begin{equation}
\Delta {vp}^j_i  = \frac{i_i^j}{c_i} T_{sw} D^j = \frac{a_i ^j }{c_i} q_{out} .
\label{eq:pumped_voltage}
\end{equation}

where $b_i^j$ is an equivalent impedance that depends on capacitor values and the circuit configuration during the $j$-th phase. It is easily derived through basic circuit analysis.

As mentioned before, one part of the delta voltage $\Delta vp_i^j$ is due to the charge redistribution and the other is due to the charge pumping. Both can be easily identified from the voltage waveforms that are present on the capacitors, shown in Figure~\ref{fig:cap_riples}. From the graph, the voltage ripple associated with the redistributed charge $\Delta vr$ can be defined as

The voltage variation due to the charge \emph{redistribution} $\Delta vr$  is obtained by substituting~\ref{eq:net_voltage} and~\ref{eq:pumped_voltage} into~\ref{eq:rdst_ripple_I}, and this yields


% 3x3 plot of dc-node fsw sweep


\begin{figure}[!h]
\newcommand\pHeigh{3.25cm}
\newcommand\pWidth{2.25cm}
\centering
    \begin{subfigure}{0.325\textwidth}
        %\raggedright
        \input{./3_modeling/rscc_dc_fsw_sw_11.tex}
    \end{subfigure}
    \hfill
    \begin{subfigure}{0.325\textwidth}
        %\centering
        \input{./3_modeling/rscc_dc_fsw_sw_12.tex}
    \end{subfigure}
    \hfill
    \begin{subfigure}{0.325\textwidth}
        %\raggedleft
        \input{./3_modeling/rscc_dc_fsw_sw_13.tex}
        %}
    \end{subfigure}

    \begin{subfigure}{0.325\textwidth}
        \centering
        \input{./3_modeling/rscc_dc_fsw_sw_21.tex}
    \end{subfigure}
    \hfill
    \begin{subfigure}{0.325\textwidth}
        \centering
       \input{./3_modeling/rscc_dc_fsw_sw_22.tex}
    \end{subfigure}
    \hfill
    \begin{subfigure}{0.325\textwidth}
        \centering
        \input{./3_modeling/rscc_dc_fsw_sw_23.tex}
    \end{subfigure}

    \begin{subfigure}{0.325\textwidth}
        \centering
        \input{./3_modeling/rscc_dc_fsw_sw_31.tex}
    \end{subfigure}
    \hfill
    \begin{subfigure}{0.325\textwidth}
        \centering
       \input{./3_modeling/rscc_dc_fsw_sw_32.tex}
    \end{subfigure}
    \hfill
    \begin{subfigure}{0.325\textwidth}
        \centering
        \input{./3_modeling/rscc_dc_fsw_sw_33.tex}
    \end{subfigure}

\caption{Equivalent Output Resistance ($r_{scc}$) from the \emph{dc}-node of the converter of Figure~\ref{fig:3_1_hscc_exp_b} as function of the switching frequency ($f_{sw}$). \emph{Left axis} - Experimental points ($\Box$) compared with this work model (\emph{solid black line}) and M. Seeman's model (\emph{solid grey line}). \emph{Right axis} - Relative error between PLECS results and this work model (\emph{black stars}) and Seeman's model (\emph{grey stars}). Plots are presented for different duty cycles: \emph{top-to-bottom}- $D = 23.3\%$, $D = 50\%$ and $D = 76.7\%$; and for different output capacitor ($c_3$) values: \emph{left-to-right}- $c_3 = c_{fly} = 100nF$, $c_2 = 10~c_{fly} = 1\mu F$ and $c_3 = 100~c_{cfly} = 100\mu F$.}
\label{fig:exp_rscc_dc_node}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Validation Chapter 4
%%%%%%%%%%%%%%%



In both cases, it has been used the same configuration to measure the equivalent output resistance, as depicted in . In the experimental arrangement, two Keithley\textsuperscript{\textregistered} \emph{SourceMeter 2440} were used to measure currents, and two Keithley\textsuperscript{\textregistered} \emph{Meters 2000} were used to measure the voltages.

%
%Only transient circuit simulations in PLECS have been used for the initial assessment and validation of the modeling work. Actually, the presented modeling has the goal to model losses produced by the charge transfer between capacitors and by conductance through resistive elements , which are the many source of losses in a SCC that mainly determine the values for capacitors and switches. By using a transient circuit simulator, we can simulate a SCC which can produce only these two source of losses, thus only reproducing studied phenomena of the models. Other source of losses such as switching losses, bottom-plate capacitors losses or driving losses, are beyond this works scope since they have been already studied and
%reported and they can be easily included in the model.



The model was validated using a 3:1 Dickson converter for the two different scenarios presented in Figure~\ref{fig:3_1_hscc_exp}. In the first scenario, the load is connected to the second \emph{pwm}-node, Figure~\ref{fig:3_1_hscc_exp_a}. In the other scenario, the converter is loaded at the \emph{dc}-node, Figure~\ref{fig:3_1_hscc_exp_b}. In both cases the output impedance values are compared with results obtained from transient PLECS\footnote{\label{fn:PLECS}Behavioral circuit simulator} simulations. Furthermore results from the second scenario are compared with results from previous modeling works.  A detailed example in how to solve the circuits and the charge flow vectors $\mathbf{a}, \mathbf{b} $ and $\mathbf{ar}$ are presented in the Appendix~\ref{apx:31_dick_charge_flows}.


%
%Only transient circuit simulations in PLECS have been used for the initial assessment and validation of the modeling work. Actually, the presented modeling has the goal to model losses produced by the charge transfer between capacitors and by conductance through resistive elements , which are the many source of losses in a SCC that mainly determine the values for capacitors and switches. By using a transient circuit simulator, we can simulate a SCC which can produce only these two source of losses, thus only reproducing studied phenomena of the models. Other source of losses such as switching losses, bottom-plate capacitors losses or driving losses, are beyond this works scope since they have been already studied and
%reported and they can be easily included in the model.

The values for capacitors $c_1$,$c_2$ and $c_3$ are 100nF and all switches have the same \emph{on}-channel resistance of $100m\Omega$. The circuits were supplied at $10V$ and 

%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%
 Small signal
%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%

\begin{figure}[!h]
    \centering
    \input{./5_hscc_led_driver/hscc_small_signal.tex}
    \caption[]{Close-loop block diagram.}
    \label{fig:close_loop_diagram}
\end{figure}